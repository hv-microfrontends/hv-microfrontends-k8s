# hv-micro-frontends

## What

**[Micro frontends](https://martinfowler.com/articles/micro-frontends.html)** *"are a recent trend of breaking up frontend monoliths into many smaller, more manageable pieces, and how this architecture can increase the effectiveness and efficiency of teams working on frontend code."* - Cam Jackson

## Goal

The main goal of this project is to explore a Micro Frontends Architecture which allows us to create a more modular frontend, composed by smaller services that can be developed, tested and deployed independently.

One of the main concerns in order to achieve independent deliverables was the creation of a friendly development environment.

That means that **each service can be developed in isolation**, and without complex configurations they should be deployed togetter in order to work as a single cohesive product.

## Use case

There are many [integration approaches](https://martinfowler.com/articles/micro-frontends.html#IntegrationApproaches). Given the assumptions of our applications we followed a **[Runtime Integration via Javascipt](https://martinfowler.com/articles/micro-frontends.html#Run-timeIntegrationViaJavascript)** approach with Multiple SPA on different URLs.

- Assumptions:
  - The same UI technology: [React](https://reactjs.org/).
  - The same UI components: [hv-uikit-react](https://github.com/pentaho/hv-uikit-react)
  - The same libraries for: state management([Redux](https://redux.js.org/)), routing ([react-router](https://reacttraining.com/react-router/web/guides/quick-start)) ...

Following these assumptions we can create an architecture that optimizes the resources shared across services.

  - Structure:
    - **CONTAINER** - The [container](https://github.com/francisco-guilherme/hv-microfrontends/tree/master/services/container) determines which service should be mounted, according to the [services](https://github.com/francisco-guilherme/hv-microfrontends/blob/master/services/container/config/services.js) configured, and calls the relevant function to tell a service when and where to render itself.
    - **SERVICES (people/ starships)** - Each service is included onto the page using a `<script>` tag, and upon load exposes a global function as its entry-point.

We use webpack capabilities to optimize the bundles generated by each service and set common resurces as [externals](https://github.com/francisco-guilherme/hv-microfrontends/blob/master/services/people/config/webpack/prod.js#L12) in order to avoid bundle the same dependencies multiple times.

The container  will be the one resposible to [include](https://github.com/francisco-guilherme/hv-microfrontends/blob/master/services/container/public/index.html) the common resources. For now we followed the easy path but there are many aspects will need to figure out (common resources versioning...)

## Deployment environments
For now, the project is configured to run mainly in dev mode.
It allows the developer to take advantage of the multiple deployment enviroments and keep fast feedback cycles along the way.

### **Standalone**
Each service is a react application and can be developed in isolation. 

For example, you can run `people` service like this:
```
$ cd services/people
$ npm i
$ npm start

Go to - http://localhost:3001/people - you'll see a list of Star Wars characters.

```
### **Test integration locally**
If we have multiple services and want to test their integration we can create a monorepo and use [Lerna](https://github.com/lerna/lerna) to manage it.

To test all current services integration locally:

```
$ npm i
$ lerna bootstrap 
$ npm start

Go to - http://localhost:3000 - you'll see links for /people, /starships, /page.

Try each link to load each external service.
```

### **Dockerize services**

You may not want to have a monorepo to manage your services, but still want to test their integration.

For that we can use `Docker`. Each service has their own Dockerfile. <br>
Using `Docker Compose` you can run the multiple containers created and test their integration.

- Pre-requisites: you need to have [Docker](https://docs.docker.com) and [Docker Compose](https://docs.docker.com/compose/install/) installed.

```
$ npm run docker

It starts all services on multiple-container Docker environments.

Go to - http://localhost:3000 - you'll see links for /people, /starships, /page.

Try each link to load each external service.
```

### **Deploy on Kubernetes**
Our services need to run on [Kubernetes](https://kubernetes.io/).
In order to test them we created a k8s local environment.

We’ll be using [minikube](https://github.com/kubernetes/minikube), which allows us to run Kubernetes locally.

- Pre-requisites: you need to have [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/), [Docker](https://docs.docker.com), [minikube](https://github.com/kubernetes/minikube) and [skaffold](https://github.com/GoogleContainerTools/skaffold) installed.

Let’s start the minikube cluster. It might take a while,
```
$ minikube start
```

We'll be using `skaffold` to facilitate continuous development for Kubernetes applications. You can iterate on your application source code locally then deploy to local or remote Kubernetes clusters.

```
$ npm run k8s

It handles the workflow for building, pushing and deploying the services for our local kubernetes.

Go to - http://localhost:3000 - you'll see links for /people, /starships, /page.

Try each link to load each external service.
```

For all these deployments, don't forget that the services will automatically reload if you make changes to the code.

---

## What's missing:
- Redux sub state. Inject state in runtime for each service and deal with shared state.
- Load multiple bundles from same service. Deal with lazy loading at component or route level.
- How to avoid bundle UI Kit on each service. For now it cannot be an external resource.
- External dependencies with multiple/ different versions.

### References:
- https://martinfowler.com/articles/micro-frontends.html
- https://micro-frontends.org/
- https://medium.com/@yzhong.cs/developing-microservices-with-minikube-81b31e5366ac
- https://github.com/corneliusweig/skaffold-create-react-app
- https://dev.to/rsschouwenaar/thoughts-about-micro-frontends-in-2020-39ed